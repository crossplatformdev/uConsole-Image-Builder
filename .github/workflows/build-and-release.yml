name: Build and Release uConsole Images

on:
  push:
    branches:
      - '**'
  workflow_dispatch:
    inputs:
      kernel_mode:
        description: 'Kernel mode (build/prebuilt)'
        required: true
        default: 'build'
        type: choice
        options:
          - build
        default: prebuilt
      create_release:
        description: 'Create a GitHub release'
        required: true
        type: boolean
        default: false

env:
  KERNEL_MODE: ${{ github.event.inputs.kernel_mode || 'build' }}

jobs:
  prepare-kernel:
    runs-on: ubuntu-24.04
    outputs:
      kernel_mode: ${{ env.KERNEL_MODE }}
    steps:
      - name: Checkout repository
        if: env.KERNEL_MODE == 'build'
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build ClockworkPi kernel using Docker
        run: |
          sudo ./scripts/build_kernel_docker.sh artifacts/kernel-debs
      
      - name: Verify kernel build output
        run: |
          echo "Checking kernel build artifacts..."
          echo "Contents of artifacts directory:"
          ls -laR artifacts/ || echo "artifacts/ directory not found"
          echo ""
          echo "Checking for .deb files:"
          find artifacts/ -name "*.deb" -ls || echo "No .deb files found"
          echo ""
          echo "Disk space usage:"
          df -h
      
      - name: Get kernel source info
        id: kernel_info
        run: |
          cd /tmp/kernel-build || true
          KERNEL_REPO="https://github.com/raspberrypi/linux.git"
          KERNEL_COMMIT="391c2e3f0599e948194a8bdc89a8ea87cd8f7d6c"
          KERNEL_BRANCH="rpi-6.12.y"
          echo "repo=${KERNEL_REPO}" >> $GITHUB_OUTPUT
          echo "commit=${KERNEL_COMMIT}" >> $GITHUB_OUTPUT
          echo "branch=${KERNEL_BRANCH}" >> $GITHUB_OUTPUT
      
      - name: Create kernel info artifact
        run: |
          sudo dpkg --add-architecture arm64
          
          sudo sed -i 's/^# deb-src/deb-src/' /etc/apt/sources.list 
          sudo sed -i 's/deb /deb [arch=amd64] /' /etc/apt/sources.list
          sudo sed -i 's/deb-src /deb-src [arch=amd64] /' /etc/apt/sources.list

          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ noble main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb-src [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ noble main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list

          sudo apt update
          sudo apt -y install bc bison flex libssl-dev make libc6-dev libncurses5-dev wget
          sudo apt -y install build-essential debhelper-compat libelf-dev libssl-dev libssl-dev:arm64
          sudo apt -y install crossbuild-essential-arm64
          sudo apt build-dep -y linux linux-image-unsigned-*-generic linux-image-unsigned-*-lowlatency

          cd linux

          export URL="https://github.com/raspberrypi/linux/compare/rpi-6.12.y...ak-rex:ClockworkPi-linux:rpi-6.12.y.diff"
          export orig="$(basename "$URL")"
          export safe="$(echo "$orig" | sed 's/[^A-Za-z0-9._-]/_/g')"
          
          echo "Downloading $URL -> $safe"
          wget -q -O "$safe" "$URL"

          export PATCH_ABSOLUTE_PATH=`pwd`/"$safe"
          
          export KERNEL=kernel8
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export LOCALCONFIG=-raspi
          patch -p1 < "$safe"
          make bcm2711_defconfig
          make deb-pkg -j$(($(nproc) + 2))

      - name: Upload kernel artifacts
        if: env.KERNEL_MODE == 'build'
        uses: actions/upload-artifact@v4
        with:
          name: kernel-debs
          path: |
            ./*.deb
            
      - name: Upload patch
        if: env.KERNEL_MODE == 'build'
        uses: actions/upload-artifact@v4
        with:
          name: kernel-patch
          path: $PATCH_ABSOLUTE_PATH

  build-image:
    needs: prepare-kernel
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        distro: [bookworm, trixie, jammy]
    steps:
      - name: Set up QEMU user-mode emulation
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64
      
      - name: Add 4GB swap to avoid apt OOM        
        run: |
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Install qemu-user-static and binfmt-support
        run: |
          export SUITE=${{ matrix.suite }}
          export KERNEL_MODE=${{ steps.kernel_mode.outputs.mode }}
          export COMPRESS_FORMAT=xz
          export OUTPUT_DIR=output/images
          sudo -E ./scripts/generate_rpi_image.sh
        env:
          DEBIAN_FRONTEND: noninteractive
      
      - name: Verify image build output
        run: |
          echo "Checking image build artifacts..."
          echo "Contents of output directory:"
          ls -laR output/ || echo "output/ directory not found"
          echo ""
          echo "Checking for image files:"
          find output/ -name "*.img*" -ls || echo "No image files found"
          echo ""
          echo "Disk space usage:"
          df -h
      
      - name: Generate checksums
        run: |
          # Verify image files exist
          if [ ! -d output/images ] || [ -z "$(ls -A output/images/uconsole-${{ matrix.suite }}-*.img.xz 2>/dev/null)" ]; then
            echo "ERROR: No image files found in output/images/" >&2
            echo "Contents of output directory:" >&2
            ls -laR output/ >&2 || echo "output/ directory not found" >&2
            exit 1
          fi
          
          cd output/images
          sha256sum uconsole-${{ matrix.suite }}-*.img.xz > uconsole-${{ matrix.suite }}-arm64.sha256
          cat uconsole-${{ matrix.suite }}-arm64.sha256
      
      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: uconsole-${{ matrix.suite }}-image
          path: |
            output/images/uconsole-${{ matrix.suite }}-*.img.xz
            output/images/uconsole-${{ matrix.suite }}-*.sha256
          retention-days: 30
          compression-level: 0
  
  create-release:
    name: Create GitHub Release
    needs: [build-kernel, build-images]
    runs-on: ubuntu-latest
    if: |
      always() &&
      (needs.build-images.result == 'success') &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.create_release))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone rpi-image-gen
        if: matrix.distro == 'bookworm' || matrix.distro == 'trixie'
        run: |
          git clone https://github.com/raspberrypi/rpi-image-gen.git
          cd rpi-image-gen
          sudo ./install_deps.sh
          ./rpi-image-gen layer --list
          sed -i 's/rpi5/rpi-cm4/g' ./config/${{ matrix.distro }}-minbase.yaml
          sed -i '/^name:/a mode: unshare' ./config/${{ matrix.distro }}-minbase.yaml


      - name: Download kernel artifacts
        if: needs.prepare-kernel.outputs.kernel_mode == 'build' && (matrix.distro == 'bookworm' || matrix.distro == 'trixie')
        uses: actions/download-artifact@v4
        with:
          name: kernel-debs
          path: ./kernel-debs

      - name: Build base image
        if: matrix.distro == 'bookworm' || matrix.distro == 'trixie'
        run: |
          cd rpi-image-gen
          ./rpi-image-gen build -c ./config/${{ matrix.distro }}-minbase.yaml

      - name: Customize image
        run: |
          # If matrix.distro is bookworm, use deb12-arm64-min.img
          # If matrix.distro is trixie, use deb13-arm64-min.img
          # If matrix.distro is jammy, use jammy for pi 4 (arm64) wget https://cdimage.ubuntu.com/releases/jammy/release/ubuntu-22.04.5-preinstalled-desktop-arm64+raspi.img.xz
          if [ "${{ matrix.distro }}" == "bookworm" ] || [ "${{ matrix.distro }}" == "trixie" ]; then            
            # If matrix.distro is bookworm, 
            if [ "${{ matrix.distro }}" == "bookworm" ]; then
              IMAGE_PATH=/home/runner/work/uConsole-Image-Builder/uConsole-Image-Builder/rpi-image-gen/work/image-deb12-arm64-min/deb12-arm64-min.img
            else
              IMAGE_PATH=/home/runner/work/uConsole-Image-Builder/uConsole-Image-Builder/rpi-image-gen/work/image-deb13-arm64-min/deb13-arm64-min.img
            fi
          fi
          
          if [ "${{ matrix.distro }}" == "jammy" ]; then
            IMAGE_PATH=https://cdimage.ubuntu.com/releases/jammy/release/ubuntu-22.04.5-preinstalled-desktop-arm64+raspi.img.xz
            wget $IMAGE_PATH -O ubuntu-jammy-raspi.img.xz
            unxz ubuntu-jammy-raspi.img.xz
            IMAGE_PATH=./ubuntu-jammy-raspi.img
          fi

          if [ "${{ matrix.distro }}" == "popos" ]; then
            IMAGE_PATH=https://iso.pop-os.org/22.04/arm64/raspi/4/pop-os_22.04_arm64_raspi_4.img.xz
            wget $IMAGE_PATH -O pop-os_22.04_arm64_raspi_4.img.xz
            unxz pop-os_22.04_arm64_raspi_4.img.xz
            IMAGE_PATH=./pop-os_22.04_arm64_raspi_4.img
          fi

          LOOP_DEVICE=$(sudo losetup -f)
          MOUNT_POINT=./rootfs

          echo "=====> IMAGE PATH: $IMAGE_PATH"
          echo "=====> LOOP DEVICE: $LOOP_DEVICE"
          echo "=====> MOUNT POINT: $MOUNT_POINT"


          # Create loop device and mount partitions
          sudo losetup -D  # Clear existing loop devices

          sudo losetup $LOOP_DEVICE -P "$IMAGE_PATH"
          
          sudo mkdir -p $MOUNT_POINT
          sudo mount ${LOOP_DEVICE}p2 $MOUNT_POINT
          sudo mount ${LOOP_DEVICE}p1 $MOUNT_POINT/boot/firmware
          sudo mount --bind /dev $MOUNT_POINT/dev
          sudo mount --bind /dev/pts $MOUNT_POINT/dev/pts
          sudo mount --bind /proc $MOUNT_POINT/proc
          sudo mount --bind /sys $MOUNT_POINT/sys

          sleep 5  # Wait for mounts to stabilize

          # Configure DNS resolvers
          sudo chroot $MOUNT_POINT /bin/bash -c "mv /etc/resolv.conf /etc/resolv.conf.bak || true"
          sudo chroot $MOUNT_POINT /bin/bash -c "echo 'nameserver 8.8.8.8' | tee /etc/resolv.conf"
          sudo chroot $MOUNT_POINT /bin/bash -c "echo 'nameserver 8.8.4.4' | tee -a /etc/resolv.conf"

          # Add ClockworkPi repository
          ## If matrix distro is jammy, use ubuntu jammy repo
          sudo chroot $MOUNT_POINT /bin/bash -c "apt-get update && apt-get install -y wget gnupg"
          sudo chroot $MOUNT_POINT /bin/bash -c "wget -qO - https://raw.githubusercontent.com/clockworkpi/apt/main/debian/KEY.gpg | gpg --dearmor | tee /etc/apt/trusted.gpg.d/clockworkpi.gpg"
          if [ "${{ matrix.distro }}" == "jammy" ]; then
            echo "deb https://raw.githubusercontent.com/clockworkpi/apt/main/bookworm stable main" | sudo tee $MOUNT_POINT/etc/apt/sources.list.d/clockworkpi.list
          else
            #echo "deb https://raw.githubusercontent.com/clockworkpi/apt/main/${{ matrix.distro }} stable main" | sudo tee $MOUNT_POINT/etc/apt/sources.list.d/clockworkpi.list
            echo "deb https://raw.githubusercontent.com/clockworkpi/apt/main/bookworm stable main" | sudo tee $MOUNT_POINT/etc/apt/sources.list.d/clockworkpi.list
          fi

          
          # Install packages in chroot
          sudo chroot $MOUNT_POINT /bin/bash -c "apt update && apt install -y clockworkpi-audio clockworkpi-cm-firmware"
          
          if [ "${{ needs.prepare-kernel.outputs.kernel_mode }}" == "prebuilt" ]; then
            sudo chroot $MOUNT_POINT /bin/bash -c "apt install -y uconsole-kernel-cm4-rpi"
          else
            sudo cp ../kernel-debs/*.deb $MOUNT_POINT/tmp/
            sudo chroot $MOUNT_POINT /bin/bash -c "dpkg -i /tmp/*.deb || apt install -f -y"
          fi

          # Set LOCALE to en_US.UTF-8
          sudo chroot $MOUNT_POINT /bin/bash -c "apt install -y locales"
          sudo chroot $MOUNT_POINT /bin/bash -c "echo 'en_US.UTF-8 UTF-8' >> /etc/locale.gen && locale-gen en_US.UTF-8 && update-locale LANG=en_US.UTF-8"
          
          # Restore original resolv.conf
          sudo chroot $MOUNT_POINT /bin/bash -c "mv /etc/resolv.conf.bak /etc/resolv.conf || true"

          # Clean up
          sudo umount $MOUNT_POINT/dev/pts
          sudo umount $MOUNT_POINT/dev
          sudo umount $MOUNT_POINT/proc
          sudo umount $MOUNT_POINT/sys
          
          sudo umount $MOUNT_POINT/boot/firmware
          sudo umount $MOUNT_POINT
          sudo losetup -d $LOOP_DEVICE
          
          # Compress image
          xz --threads=1 --memory=1000MiB --check=crc32 --compress --keep "$IMAGE_PATH"
          mv "${IMAGE_PATH}.xz" /home/runner/work/uConsole-Image-Builder/uconsole-${{ matrix.distro }}-cm4.img.xz         
      
      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          path: uconsole-${{ matrix.distro }}-cm4.img.xz

  release:
    needs: [prepare-kernel, build-image]
    runs-on: ubuntu-24.04
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create release tag
        id: tag
        run: |
          TAG_NAME="release-$(date +'%Y%m%d-%H%M%S')"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          git tag $TAG_NAME
          git push origin $TAG_NAME

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          files: |
            kernel-debs/*.deb
            kernel-patch/*.diff
            uconsole-*-image/*.img.xz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
