name: Build and Release uConsole Images

on:
  push:
    branches:
      - '**'
  workflow_dispatch:
    inputs:
      kernel_mode:
        description: 'Kernel mode (build/prebuilt)'
        required: true
        default: prebuilt
        type: choice
        options:
          - build
          - prebuilt
      kernel_arch:
        description: 'Kernel arch'
        required: true
        default: arm64
        type: choice
        options:
          - arm64
          - riscv
      kernel_version:
        description: 'Kernel branch'
        required: true
        default: rpi-6.12.y
        type: choice
        options:
          - rpi-6.12.y
          - riscv          
env:
  KERNEL_MODE: ${{ github.event.inputs.kernel_mode || 'prebuilt' }}
  KERNEL_VERSION: ${{ github.event.inputs.kernel_version || 'rpi-6.12.y' }}
  KERNEL_ARCH: ${{ github.event.inputs.kernel_arch || 'arm64' }}
  KERNEL_COMMIT: 'rpi-6.12.y_20241206_2' # 'rpi-6.12.y'  # Can be modified to point to specific commit or branch
  # apt packages that will be installed on the images
  UBUNTU_TASKS: 'ubuntu-standard ubuntu-server ubuntu-server-raspi task-laptop network-manager netplan.io wpasupplicant net-tools openssh-client openssh-server rfkill fdisk powertop cpufreq*'
  DEBIAN_TASKS: 'live-task-standard live-task-recommended task-laptop laptop-mode-tools network-manager netplan.io wpasupplicant net-tools openssh-client openssh-server rfkill fdisk powertop cpufreq*'

jobs:
  prepare-kernel:
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
    strategy:
      matrix:
        uconsole_core: [cm3, cm4, cm5]
    outputs:
      kernel_mode: ${{ env.KERNEL_MODE }}
    steps:
      - name: Set DNS to Google (optional)
        run: |
          echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf > /dev/null
                  
      - name: Checkout repository
        if: env.KERNEL_MODE == 'build'
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build kernel
        if: env.KERNEL_MODE == 'build'
        run: |
          #sudo dpkg --add-architecture arm64
          # enable debian sources
          cat /etc/apt/sources.list.d/ubuntu.sources
          sudo sed -i 's/deb/deb deb-src/g' /etc/apt/sources.list.d/ubuntu.sources
          sudo apt update 

          sudo apt install -y bc bison flex libssl-dev make libc6-dev libncurses5-dev
          sudo apt install -y build-essential
          sudo apt build-dep -y -a arm64 linux linux-raspi
          cd linux

          export URL="https://github.com/raspberrypi/linux/compare/rpi-6.12.y...ak-rex:ClockworkPi-linux:rpi-6.12.y.diff"
          export orig="$(basename "$URL")"
          export safe=uconsole-kernel-patch.diff
          
          echo "Downloading $URL -> $safe"
          if ! wget -q -O "$safe" "$URL"; then
            echo "Failed to download patch, exiting"
            exit 1
          fi

          if [ ! -f "$safe" ] || [ ! -s "$safe" ]; then
            echo "Patch file is empty or missing, exiting"
            exit 1
          fi

          export PATCH_ABSOLUTE_PATH="$(pwd)/$safe"
          
          ## All CM3, CM4, and CM5 use the same kernel configuration
          export KERNEL=kernel8
          
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export LOCALVERSION=-raspi
          
          if ! patch -p1 < "$safe"; then
            echo "Patch application failed, exiting"
            exit 1
          fi

          # Use bcm2711_defconfig for all cores (cm3, cm4, cm5)
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- bcm2711_defconfig
          
          make deb-pkg -j$(($(nproc) + 2)) LOCALVERSION=-raspi

          mkdir -p /home/runner/work/uConsole-Image-Builder/kernel-debs-${{ matrix.uconsole_core }}/
          
          mv ../*.deb /home/runner/work/uConsole-Image-Builder/kernel-debs-${{ matrix.uconsole_core }}/
          mv "$safe" /home/runner/work/uConsole-Image-Builder/uconsole-kernel-patch-${{ matrix.uconsole_core }}.diff

      - name: Upload kernel artifacts (1)
        if: env.KERNEL_MODE == 'build'
        uses: actions/upload-artifact@v4
        with:
          name: kernel-debs-${{ matrix.uconsole_core }}
          path: |
            /home/runner/work/uConsole-Image-Builder/kernel-debs-${{ matrix.uconsole_core }}/*.deb

      - name: Upload kernel artifacts (2) 
        if: env.KERNEL_MODE == 'build'
        uses: actions/upload-artifact@v4
        with:
          name: kernel-patch-uconsole-${{ matrix.uconsole_core }}
          path: |
            /home/runner/work/uConsole-Image-Builder/uconsole-kernel-patch-${{ matrix.uconsole_core }}.diff

  build-image:
    name: ${{ matrix.device }}-${{ needs.prepare-kernel.outputs.kernel_mode }}-image-${{ matrix.distro }}-${{ matrix.uconsole_core }}-${{ matrix.desktop }}
    needs: prepare-kernel
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
    strategy:
      matrix:
        distro: [bookworm, trixie, jammy]
        uconsole_core: [cm3, cm4, cm5]
        device: [devterm, uconsole]
        desktop: [gnome, kde, cinnamon, mate, xfce, lxde, lxqt, gnome-flashback]
        exclude:
          # RetroPie only works with Debian-based distros (bookworm, trixie), not Ubuntu
          - distro: jammy
            desktop: retropie
    outputs:
      image: ${{ matrix.distro }}
      kernel_version: ${{ env.KERNEL_VERSION }}
      kernel_arch: ${{ env.KERNEL_ARCH }}      
    steps:
      - name: Set up QEMU user-mode emulation
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64
      
      - name: Install qemu-user-static and binfmt-support
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static binfmt-support
          # ensure update-binfmts exists and qemu-aarch64 interpreter is enabled
          if command -v update-binfmts >/dev/null 2>&1; then
            sudo update-binfmts --enable qemu-aarch64 || true
          fi

      - name: Install Debian archive keys and required tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg ca-certificates debian-archive-keyring

          # Ensure Debian archive keys are present
          sudo apt-get install -y --reinstall debian-archive-keyring || true

          KEYS=(6ED0E7B82643E131 78DBA3BC47EF2265 F8D2585B8783D481 BDE6D2B9216EC7A8 8E9F831205B4BA95 762F67A0B2C39DE4 54404762BBB6E853)
          for key in "${KEYS[@]}"; do
            # Try HKPS first, fallback to hkp; make gpg non-interactive
            gpg --batch --no-tty --keyserver hkps://keyserver.ubuntu.com --recv-keys "$key" \
              || gpg --batch --no-tty --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys "$key"
            # Export and dearmor into apt trusted dir without invoking sudo gpg
            gpg --batch --no-tty --export "$key" | gpg --batch --no-tty --dearmor | sudo tee /etc/apt/trusted.gpg.d/${key}.gpg > /dev/null
          done

          # Sanity update (should succeed now)
          sudo apt-get update
          
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set desktop task packages
        id: desktop_task
        run: |
          # Map desktop environment to appropriate task packages
          case "${{ matrix.desktop }}" in
            gnome)
              if [ "${{ matrix.distro }}" == "jammy" ]; then
                echo "DESKTOP_TASK=ubuntu-gnome-desktop" >> $GITHUB_ENV
              else
                echo "DESKTOP_TASK=task-gnome-desktop" >> $GITHUB_ENV
              fi
              ;;
            kde)
              if [ "${{ matrix.distro }}" == "jammy" ]; then
                echo "DESKTOP_TASK=kubuntu-desktop" >> $GITHUB_ENV
              else
                echo "DESKTOP_TASK=task-kde-desktop" >> $GITHUB_ENV
              fi
              ;;
            cinnamon)
              echo "DESKTOP_TASK=task-cinnamon-desktop" >> $GITHUB_ENV
              ;;
            mate)
              if [ "${{ matrix.distro }}" == "jammy" ]; then
                echo "DESKTOP_TASK=ubuntu-mate-desktop" >> $GITHUB_ENV
              else
                echo "DESKTOP_TASK=task-mate-desktop" >> $GITHUB_ENV
              fi
              ;;
            xfce)
              if [ "${{ matrix.distro }}" == "jammy" ]; then
                echo "DESKTOP_TASK=xubuntu-desktop" >> $GITHUB_ENV
              else
                echo "DESKTOP_TASK=task-xfce-desktop" >> $GITHUB_ENV
              fi
              ;;
            lxde)
              if [ "${{ matrix.distro }}" == "jammy" ]; then
                echo "DESKTOP_TASK=lxde" >> $GITHUB_ENV
              else
                echo "DESKTOP_TASK=task-lxde-desktop" >> $GITHUB_ENV
              fi
              ;;
            lxqt)
              if [ "${{ matrix.distro }}" == "jammy" ]; then
                echo "DESKTOP_TASK=lubuntu-desktop" >> $GITHUB_ENV
              else
                echo "DESKTOP_TASK=task-lxqt-desktop" >> $GITHUB_ENV
              fi
              ;;
            gnome-flashback)
              if [ "${{ matrix.distro }}" == "jammy" ]; then
                echo "DESKTOP_TASK=ubuntu-gnome-desktop gnome-session-flashback" >> $GITHUB_ENV
              else
                echo "DESKTOP_TASK=task-gnome-flashback-desktop" >> $GITHUB_ENV
              fi
              ;;
            retropie)
              # RetroPie uses pi-gen build system, no desktop task needed
              echo "DESKTOP_TASK=" >> $GITHUB_ENV
              echo "IS_RETROPIE=true" >> $GITHUB_ENV
              ;;
            *)
              echo "ERROR: Unknown desktop environment: ${{ matrix.desktop }}"
              echo "Supported desktop environments: gnome, kde, cinnamon, mate, xfce, lxde, lxqt, gnome-flashback, retropie"
              exit 1
              ;;
          esac
          echo "Desktop task set to: $DESKTOP_TASK"

      - name: Setup ClockworkPi-pi-gen for RetroPie
        if: matrix.desktop == 'retropie' && (matrix.distro == 'bookworm' || matrix.distro == 'trixie')
        run: |
          # Verify submodule is checked out
          if [ ! -f rpi-image-gen/build.sh ]; then
            echo "ERROR: ClockworkPi-pi-gen submodule not properly checked out"
            exit 1
          fi
          cd rpi-image-gen
                    sudo apt-get update
          sudo apt-get install -y gnupg ca-certificates debian-archive-keyring

          # Ensure Debian archive keys are present
          sudo apt-get install -y --reinstall debian-archive-keyring || true

          KEYS=(6ED0E7B82643E131 78DBA3BC47EF2265 F8D2585B8783D481 BDE6D2B9216EC7A8 8E9F831205B4BA95 762F67A0B2C39DE4 54404762BBB6E853)
          for key in "${KEYS[@]}"; do
            # Try HKPS first, fallback to hkp; make gpg non-interactive
            gpg --batch --no-tty --keyserver hkps://keyserver.ubuntu.com --recv-keys "$key" \
              || gpg --batch --no-tty --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys "$key"
            # Export and dearmor into apt trusted dir without invoking sudo gpg
            gpg --batch --no-tty --export "$key" | gpg --batch --no-tty --dearmor | sudo tee /etc/apt/trusted.gpg.d/${key}.gpg > /dev/null
          done

          # Install dependencies for pi-gen
          sudo apt-get update
          sudo apt-get install -y coreutils quilt parted qemu-user-static debootstrap zerofree zip \
            dosfstools e2fsprogs libarchive-tools libcap2-bin grep rsync xz-utils file git curl bc \
            gpg pigz xxd arch-test bmap-tools kmod debian-archive-keyring

          # Install debian-archive-keyring on host to ensure latest keys are available
          # This helps debootstrap work properly with updated repository signing keys
          sudo apt-get install -y debian-archive-keyring
          
          # Import additional Debian GPG keys that may be needed
          # These keys are required for apt operations in the bootstrapped Debian systems
          KEYS="6ED0E7B82643E131 78DBA3BC47EF2265 F8D2585B8783D481 BDE6D2B9216EC7A8 8E9F831205B4BA95 762F67A0B2C39DE4 54404762BBB6E853"
          for key in $KEYS; do
            # Try HKPS first, fallback to hkp; make gpg non-interactive
            gpg --batch --no-tty --keyserver hkps://keyserver.ubuntu.com --recv-keys "$key" \
              || gpg --batch --no-tty --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys "$key" || true
            # Export directly to host's apt trusted directory so debootstrap can use them (already dearmored)
            gpg --batch --no-tty --export "$key" | gpg --batch --no-tty --dearmor | sudo tee "/etc/apt/trusted.gpg.d/debian-${key}.gpg" > /dev/null
          done
          
          # Create stage0 directory for chroot scripts
          mkdir -p stage0/00-debian-keys/files
          
          # Export keys to files that will be copied into the chroot after it's created
          for key in $KEYS; do
            gpg --batch --no-tty --export "$key" | sudo tee "stage0/00-debian-keys/files/${key}.gpg" > /dev/null
          done
          
          # Create a chroot script that will execute inside the chroot after it's created
          # This runs after debootstrap completes and the rootfs exists
          cat > stage0/00-debian-keys/00-run-chroot.sh << 'CHROOT'
          #!/bin/bash -e
          # Install Debian GPG keys in the chroot before any apt operations
          # Copy GPG keys into apt's trusted directory
          for keyfile in /stage0/00-debian-keys/files/*.gpg; do
            if [ -f "$keyfile" ]; then
              cp "$keyfile" "/etc/apt/trusted.gpg.d/$(basename "$keyfile")"
              chmod 644 "/etc/apt/trusted.gpg.d/$(basename "$keyfile")"
            fi
          done
          # Also ensure debian-archive-keyring is installed in the chroot
          apt-get update || true
          apt-get install -y --no-install-recommends debian-archive-keyring || true
          CHROOT
          chmod +x stage0/00-debian-keys/00-run-chroot.sh

          # Configure for RetroPie build
          cat > config << EOF
          IMG_NAME="ClockworkPi-${{ matrix.distro }}-RetroPie"
          RELEASE="${{ matrix.distro }}"
          DEPLOY_COMPRESSION="xz"
          TARGET_HOSTNAME="uconsole"
          FIRST_USER_NAME="clockworkpi"
          FIRST_USER_PASS="clockworkpi"
          ENABLE_SSH=1
          STAGE_LIST="stage0 stage1 stage2 stage2-retropie"
          EOF

      - name: Setup rpi-image-gen for standard desktops
        if: matrix.desktop != 'retropie' && (matrix.distro == 'bookworm' || matrix.distro == 'trixie')
        run: |
          # For non-RetroPie builds, we don't use pi-gen
          # Instead, we'll use the current workflow approach of building a minimal base
          # and then customizing it with the desired desktop
          echo "Skipping pi-gen setup for non-RetroPie desktop builds"
          echo "Will use debootstrap approach instead"


      - name: Download kernel artifacts
        if: needs.prepare-kernel.outputs.kernel_mode == 'build'
        uses: actions/download-artifact@v4
        with:
          name: kernel-debs-${{ matrix.uconsole_core }}
          path:  /home/runner/work/uConsole-Image-Builder/uConsole-Image-Builder/kernel-debs/

      - name: Build RetroPie image with ClockworkPi-pi-gen
        if: matrix.desktop == 'retropie' && (matrix.distro == 'bookworm' || matrix.distro == 'trixie')
        run: |
          set -e  # Exit on any error
          cd rpi-image-gen
          # Run pi-gen build for RetroPie
          if ! sudo ./build.sh; then
            echo "ERROR: ClockworkPi-pi-gen build failed"
            exit 1
          fi
          
          # The output will be in the deploy directory
          # Move it to a known location for later steps
          mkdir -p /home/runner/work/uConsole-Image-Builder/uConsole-Image-Builder/retropie-output
          
          # Check if build artifacts exist
          if [ ! -d deploy ] || [ -z "$(ls -A deploy 2>/dev/null)" ]; then
            echo "ERROR: No build artifacts found in deploy directory"
            ls -la deploy/ || echo "Deploy directory doesn't exist"
            exit 1
          fi
          
          # Move artifacts
          shopt -s nullglob
          for f in deploy/*.img deploy/*.img.xz; do
            sudo mv "$f" /home/runner/work/uConsole-Image-Builder/uConsole-Image-Builder/retropie-output/
          done
          shopt -u nullglob

      - name: Build base image for standard desktops
        if: matrix.desktop != 'retropie' && (matrix.distro == 'bookworm' || matrix.distro == 'trixie')
        run: |
          # For non-RetroPie builds, create a minimal Debian base using debootstrap
          # This replaces the rpi-image-gen approach
          echo "Creating minimal ${{ matrix.distro }} base with debootstrap"
          
          # Install debootstrap if not already present
          sudo apt-get update
          sudo apt-get install -y debootstrap
          
          # Create a minimal base image
          IMAGE_SIZE="8G"
          if [ "${{ matrix.distro }}" == "bookworm" ]; then
            IMAGE_NAME="deb12-arm64-min.img"
          else
            IMAGE_NAME="deb13-arm64-min.img"
          fi
          
          # Create image file
          mkdir -p /home/runner/work/uConsole-Image-Builder/uConsole-Image-Builder/base-images
          IMAGE_PATH="/home/runner/work/uConsole-Image-Builder/uConsole-Image-Builder/base-images/$IMAGE_NAME"
          
          # Create an 8GB image
          dd if=/dev/zero of="$IMAGE_PATH" bs=1M count=8192 status=progress
          
          # Create partitions
          sudo parted "$IMAGE_PATH" --script mklabel msdos
          sudo parted "$IMAGE_PATH" --script mkpart primary fat32 1MiB 513MiB
          sudo parted "$IMAGE_PATH" --script mkpart primary ext4 513MiB 100%
          sudo parted "$IMAGE_PATH" --script set 1 boot on
          
          # Setup loop device
          LOOP_DEV=$(sudo losetup -f --show -P "$IMAGE_PATH")
          
          # Format partitions
          sudo mkfs.vfat -F 32 "${LOOP_DEV}p1"
          sudo mkfs.ext4 -F "${LOOP_DEV}p2"
          
          # Mount partitions
          sudo mkdir -p /mnt/base-rootfs
          sudo mount "${LOOP_DEV}p2" /mnt/base-rootfs
          sudo mkdir -p /mnt/base-rootfs/boot/firmware
          sudo mount "${LOOP_DEV}p1" /mnt/base-rootfs/boot/firmware
          
          # Bootstrap minimal Debian system
          sudo debootstrap --arch=arm64 --include=systemd,udev,apt,ca-certificates \
            ${{ matrix.distro }} /mnt/base-rootfs https://deb.debian.org/debian
          
          # Basic setup
          echo "uconsole" | sudo tee /mnt/base-rootfs/etc/hostname
          echo "127.0.0.1 localhost" | sudo tee /mnt/base-rootfs/etc/hosts
          echo "127.0.1.1 uconsole" | sudo tee -a /mnt/base-rootfs/etc/hosts
          
          # Unmount
          sudo umount /mnt/base-rootfs/boot/firmware
          sudo umount /mnt/base-rootfs
          sudo losetup -d "$LOOP_DEV"

      - name: Customize image
        if: matrix.desktop != 'retropie'
        run: |
          # If matrix.distro is bookworm, use deb12-arm64-min.img
          # If matrix.distro is trixie, use deb13-arm64-min.img
          # If matrix.distro is jammy, use jammy for pi 4 (arm64) wget https://cdimage.ubuntu.com/releases/jammy/release/ubuntu-22.04.5-preinstalled-desktop-arm64+raspi.img.xz
          if [ "${{ matrix.distro }}" == "bookworm" ] || [ "${{ matrix.distro }}" == "trixie" ]; then            
            # If matrix.distro is bookworm, 
            if [ "${{ matrix.distro }}" == "bookworm" ]; then
              IMAGE_PATH=/home/runner/work/uConsole-Image-Builder/uConsole-Image-Builder/base-images/deb12-arm64-min.img
            else
              IMAGE_PATH=/home/runner/work/uConsole-Image-Builder/uConsole-Image-Builder/base-images/deb13-arm64-min.img
            fi
          fi
          
          if [ "${{ matrix.distro }}" == "jammy" ]; then
            IMAGE_PATH=https://cdimage.ubuntu.com/releases/jammy/release/ubuntu-22.04.5-preinstalled-server-arm64+raspi.img.xz
            wget $IMAGE_PATH -O ubuntu-jammy-raspi.img.xz > /dev/null 2>&1
            unxz ubuntu-jammy-raspi.img.xz
            IMAGE_PATH=./ubuntu-jammy-raspi.img
            
            # Resize image to 8GB for GNOME desktop
            echo "Resizing Ubuntu image to 8GB..."
            # Get current image size
            CURRENT_SIZE=$(stat -c%s "$IMAGE_PATH" 2>/dev/null) || {
              echo "ERROR: Failed to get image size"
              exit 1
            }
            TARGET_SIZE=$((8 * 1024 * 1024 * 1024))  # 8GB in bytes
            
            # Only resize if current size is less than target
            if [ $CURRENT_SIZE -lt $TARGET_SIZE ]; then
              # Extend the image file
              if ! truncate -s 8G "$IMAGE_PATH"; then
                echo "ERROR: Failed to extend image file to 8GB"
                exit 1
              fi
              
              # Setup loop device to resize partition
              RESIZE_LOOP=$(sudo losetup -f)
              if [ -z "$RESIZE_LOOP" ]; then
                echo "ERROR: No free loop device available"
                exit 1
              fi
              
              if ! sudo losetup -P "$RESIZE_LOOP" "$IMAGE_PATH"; then
                echo "ERROR: Failed to setup loop device"
                exit 1
              fi
              
              # Root partition for Ubuntu Raspberry Pi images
              ROOT_PARTITION="${RESIZE_LOOP}p2"
              
              # Verify partition device exists after losetup
              if [ ! -e "$ROOT_PARTITION" ]; then
                echo "ERROR: Partition device $ROOT_PARTITION not found after losetup"
                echo "Available devices:"
                ls -l ${RESIZE_LOOP}* || true
                sudo losetup -d "$RESIZE_LOOP"
                exit 1
              fi
              
              echo "Found partition device: $ROOT_PARTITION"
              
              # Resize the root partition (partition 2)
              if ! echo ", +" | sudo sfdisk --no-reread -N 2 "$RESIZE_LOOP"; then
                echo "ERROR: Failed to resize partition"
                sudo losetup -d "$RESIZE_LOOP"
                exit 1
              fi
              
              if ! sudo partprobe "$RESIZE_LOOP"; then
                echo "ERROR: Failed to update partition table"
                sudo losetup -d "$RESIZE_LOOP"
                exit 1
              fi
              
              # Wait for partition device to be ready after partprobe
              sleep 2
              
              # Verify partition device still exists after resize
              if [ ! -e "$ROOT_PARTITION" ]; then
                echo "ERROR: Partition device $ROOT_PARTITION disappeared after resize"
                echo "Available devices:"
                ls -l ${RESIZE_LOOP}* || true
                sudo losetup -d "$RESIZE_LOOP"
                exit 1
              fi
              
              # Resize the filesystem - e2fsck exit codes:
              # 0 = no errors, 1 = errors corrected (acceptable), >1 = serious errors
              E2FSCK_EXIT=0
              sudo e2fsck -f -y "$ROOT_PARTITION" || E2FSCK_EXIT=$?
              if [ "$E2FSCK_EXIT" -gt 1 ]; then
                echo "ERROR: Filesystem check failed with exit code $E2FSCK_EXIT"
                sudo losetup -d "$RESIZE_LOOP"
                exit 1
              fi
              
              if ! sudo resize2fs "$ROOT_PARTITION"; then
                echo "ERROR: Failed to resize filesystem"
                sudo losetup -d "$RESIZE_LOOP"
                exit 1
              fi
              
              # Clean up
              sudo losetup -d "$RESIZE_LOOP"
              echo "Image resized successfully to 8GB"
            fi
          fi

          if [ "${{ matrix.distro }}" == "popos" ]; then
            IMAGE_PATH=https://iso.pop-os.org/22.04/arm64/raspi/4/pop-os_22.04_arm64_raspi_4.img.xz
            wget $IMAGE_PATH -O pop-os_22.04_arm64_raspi_4.img.xz > /dev/null 2>&1
            unxz pop-os_22.04_arm64_raspi_4.img.xz
            IMAGE_PATH=./pop-os_22.04_arm64_raspi_4.img
          fi

          LOOP_DEVICE=$(sudo losetup -f)
          MOUNT_POINT=./rootfs

          echo "=====> IMAGE PATH: $IMAGE_PATH"
          echo "=====> LOOP DEVICE: $LOOP_DEVICE"
          echo "=====> MOUNT POINT: $MOUNT_POINT"

          # Create loop device and mount partitions
          sudo losetup -D  # Clear existing loop devices

          sudo losetup $LOOP_DEVICE -P "$IMAGE_PATH"
          
          sudo mkdir -p $MOUNT_POINT
          sudo mount ${LOOP_DEVICE}p2 $MOUNT_POINT
          sudo mount ${LOOP_DEVICE}p1 $MOUNT_POINT/boot/firmware
          sudo mount --bind /dev $MOUNT_POINT/dev
          sudo mount --bind /dev/pts $MOUNT_POINT/dev/pts
          sudo mount --bind /proc $MOUNT_POINT/proc
          sudo mount --bind /sys $MOUNT_POINT/sys

          sleep 5  # Wait for mounts to stabilize
     
          # Configure DNS resolvers
          sudo chroot $MOUNT_POINT /bin/bash -c "mv /etc/resolv.conf /etc/resolv.conf.bak || true"
          sudo chroot $MOUNT_POINT /bin/bash -c "echo 'nameserver 8.8.8.8' | tee /etc/resolv.conf"
          sudo chroot $MOUNT_POINT /bin/bash -c "echo 'nameserver 8.8.4.4' | tee -a /etc/resolv.conf"

          # Remove current linux
          sudo chroot $MOUNT_POINT /bin/bash -c "apt remove -y linux-image-* linux-headers-* linux-raspi-headers-* || true"
          
          # Add ClockworkPi repository
          ## If matrix distro is jammy, use ubuntu jammy repo
          sudo chroot $MOUNT_POINT /bin/bash -c "apt-get update && apt-get install -y --no-install-recommends wget gnupg initramfs-tools"

          sudo chroot $MOUNT_POINT /bin/bash -c "wget -q -O- https://raw.githubusercontent.com/clockworkpi/apt/main/debian/KEY.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/clockworkpi.gpg"
          sudo chroot $MOUNT_POINT /bin/bash -c "echo 'deb [arch=arm64] https://raw.githubusercontent.com/clockworkpi/apt/main/bookworm stable main' | sudo tee -a /etc/apt/sources.list.d/clockworkpi.list"
          sudo chroot $MOUNT_POINT /bin/bash -c "sudo apt update"
          sudo chroot $MOUNT_POINT /bin/bash -c "sudo apt install -y --no-install-recommends clockworkpi-*"

          if [ "${{ matrix.distro }}" == "jammy" ]; then
            # Install tasks 'ubuntu-server' and 'ubuntu-desktop' without recommended packages to save space
            sudo chroot $MOUNT_POINT /bin/bash -c "apt update && apt install -y --no-install-recommends aptitude tasksel ${{ env.UBUNTU_TASKS }} ${{ env.DESKTOP_TASK }}"
          else
            # Install tasks 'debian-server' and 'debian-desktop'
            sudo chroot $MOUNT_POINT /bin/bash -c "apt update && apt install -y --no-install-recommends aptitude tasksel ${{ env.DEBIAN_TASKS }} ${{ env.DESKTOP_TASK }}"
          fi

          # Install kernel based on CM variant and kernel mode
          # CM3 and CM5 always use built kernels, CM4 can use prebuilt
          if [ "${{ matrix.uconsole_core }}" == "cm4" ] && [ "${{ env.KERNEL_MODE }}" == "prebuilt" ]; then
            sudo chroot $MOUNT_POINT /bin/bash -c "apt install -y --no-install-recommends uconsole-kernel-${{ matrix.uconsole_core }}-rpi"
          else
            sudo cp  /home/runner/work/uConsole-Image-Builder/uConsole-Image-Builder/kernel-debs/*.deb $MOUNT_POINT/tmp/
            sudo chroot $MOUNT_POINT /bin/bash -c "dpkg -i /tmp/*.deb || apt install -f -y --no-install-recommends"
          fi

          sudo chroot $MOUNT_POINT /bin/bash -c "sudo apt install -y --no-install-recommends wireguard-tools"

          # Set LOCALE to en_US.UTF-8
          sudo chroot $MOUNT_POINT /bin/bash -c "apt install -y --no-install-recommends locales tzdata"
          sudo chroot $MOUNT_POINT /bin/bash -c "echo 'en_US.UTF-8 UTF-8' >> /etc/locale.gen && locale-gen en_US.UTF-8 && update-locale LANG=en_US.UTF-8"                  
          
          # Configure uConsole-specific config.txt
          sudo tee $MOUNT_POINT/boot/firmware/config.txt << 'EOF'
          # For more options and information see
          # http://rptl.io/configtxt
          # Some settings may impact device functionality. See link above for details

          # Uncomment some or all of these to enable the optional hardware interfaces
          #dtparam=i2c_arm=on
          #dtparam=i2s=on
          #dtparam=spi=on

          # Enable audio (loads snd_bcm2835)
          dtparam=audio=on

          # Additional overlays and parameters are documented
          # /boot/firmware/overlays/README

          # Automatically load overlays for detected cameras
          camera_auto_detect=1

          # Automatically load overlays for detected DSI displays
          display_auto_detect=1

          # Automatically load initramfs files, if found
          auto_initramfs=1

          # Enable DRM VC4 V3D driver
          #dtoverlay=vc4-kms-v3d

          max_framebuffers=2

          # Don't have the firmware create an initial video= setting in cmdline.txt.
          # Use the kernel's default instead.
          #disable_fw_kms_setup=1

          # Run in 64-bit mode
          arm_64bit=1

          # Disable compensation for displays with overscan
          disable_overscan=1

          # Run as fast as firmware / board allows
          arm_boost=1

          # Enable host mode on the 2711 built-in XHCI USB controller.
          # This line should be removed if the legacy DWC2 controller is required
          # (e.g. for USB device mode) or if USB support is not required.
          #otg_mode=1

          ignore_lcd=1
          display_auto_detect=0
          dtoverlay=audremap,pins_12_13
          dtoverlay=dwc2,dr_mode=host
          dtparam=ant2

          # Enable DRM VC4 V3D driver (Clockworkpi uConsole CM4)
          #dtparam=drm_fb0_rp1_dsi1
          #initial_turbo=0
          dtparam=spi=on          
          
          EOF

          ## Configure device-specific dtoverlay based on device and uconsole_core
          if [ "${{ matrix.device }}" == "devterm" ]; then
            # DevTerm device overlays
            if [ "${{ matrix.uconsole_core }}" == "cm3" ]; then
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtoverlay=clockworkpi-devterm-cm3' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtoverlay=vc4-kms-v3d,cma-384' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtparam=pciex1=off' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'enable_uart=1' >> /boot/firmware/config.txt"
            elif [ "${{ matrix.uconsole_core }}" == "cm4" ]; then
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtoverlay=clockworkpi-devterm' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtoverlay=vc4-kms-v3d-pi4,cma-384' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtparam=pciex1=off' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'enable_uart=1' >> /boot/firmware/config.txt"
            else  # cm5
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtoverlay=clockworkpi-devterm-cm5' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtoverlay=vc4-kms-v3d-pi5,cma-384' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtparam=pciex1=off' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'enable_uart=1' >> /boot/firmware/config.txt"
            fi
          else
            # uConsole device overlays
            if [ "${{ matrix.uconsole_core }}" == "cm3" ]; then
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtoverlay=clockworkpi-uconsole-cm3' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtoverlay=vc4-kms-v3d,cma-384' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtparam=pciex1=off' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'enable_uart=1' >> /boot/firmware/config.txt"
            elif [ "${{ matrix.uconsole_core }}" == "cm4" ]; then
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtoverlay=clockworkpi-uconsole' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtoverlay=vc4-kms-v3d-pi4,cma-384' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtparam=pciex1=off' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'enable_uart=1' >> /boot/firmware/config.txt"
            else  # cm5
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtoverlay=clockworkpi-uconsole-cm5' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtoverlay=vc4-kms-v3d-pi5,cma-384' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'dtparam=pciex1=off' >> /boot/firmware/config.txt"
              sudo chroot $MOUNT_POINT /bin/bash -c "echo 'enable_uart=1' >> /boot/firmware/config.txt"
            fi
          fi

          # Generate vmlinuz (raspi kernel) initramfs
          sudo chroot $MOUNT_POINT /bin/bash -c "update-initramfs -c -k all"

          # Create user 'clockworkpi', identified by 'clockworkpi', create skeleton home directory and add to sudoers
          sudo chroot $MOUNT_POINT /bin/bash -c "adduser --gecos 'Clockwork Pi,,,,' --disabled-password clockworkpi || true"
          sudo chroot $MOUNT_POINT /bin/bash -c "echo 'clockworkpi:clockworkpi' | chpasswd"
          sudo chroot $MOUNT_POINT /bin/bash -c "usermod -aG sudo clockworkpi"
          sudo chroot $MOUNT_POINT /bin/bash -c "echo 'clockworkpi ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers"

          sudo chroot $MOUNT_POINT /bin/bash -c "mkdir -p /home/clockworkpi/Desktop"
          sudo chroot $MOUNT_POINT /bin/bash -c "chown -R clockworkpi:clockworkpi /home/clockworkpi/Desktop"

          # Set hostname
          sudo chroot $MOUNT_POINT /bin/bash -c "echo 'uconsole' > /etc/hostname"
          sudo chroot $MOUNT_POINT /bin/bash -c "sed -i 's/ubuntu|debian|raspbian|raspberrypi/uconsole/g' /etc/hosts"

          # Enable SSH by default
          sudo chroot $MOUNT_POINT /bin/bash -c "apt install -y --no-install-recommends openssh-server"
          sudo chroot $MOUNT_POINT /bin/bash -c "systemctl enable ssh"
          sudo chroot $MOUNT_POINT /bin/bash -c "touch /boot/firmware/ssh"
          
          # Set timezone to UTC
          sudo chroot $MOUNT_POINT /bin/bash -c "ln -sf /usr/share/zoneinfo/UTC /etc/localtime"
          sudo chroot $MOUNT_POINT /bin/bash -c "dpkg-reconfigure -f noninteractive tzdata"

          # Set keyboard layout to us
          sudo chroot $MOUNT_POINT /bin/bash -c "apt install -y --no-install-recommends keyboard-configuration"
          sudo chroot $MOUNT_POINT /bin/bash -c "echo 'XKBLAYOUT=\"us\"' >> /etc/default/keyboard"
          sudo chroot $MOUNT_POINT /bin/bash -c "echo 'XKBMODEL=\"pc105\"' >> /etc/default/keyboard"
          sudo chroot $MOUNT_POINT /bin/bash -c "dpkg-reconfigure -f noninteractive keyboard-configuration"
          
          # Cleanup to reduce image size
          sudo chroot $MOUNT_POINT /bin/bash -c "apt-get autoremove -y"
          sudo chroot $MOUNT_POINT /bin/bash -c "apt-get clean"
          
          # Remove unnecessary files to save space
          sudo chroot $MOUNT_POINT /bin/bash -c "rm -rf /var/lib/apt/lists/*"
          sudo chroot $MOUNT_POINT /bin/bash -c "rm -rf /tmp/*"
          sudo chroot $MOUNT_POINT /bin/bash -c "rm -rf /var/tmp/*"
          sudo chroot $MOUNT_POINT /bin/bash -c "rm -rf /var/cache/apt/archives/*.deb"
          sudo chroot $MOUNT_POINT /bin/bash -c "rm -rf /var/log/*.log /var/log/*.old /var/log/*.gz"
          #sudo chroot $MOUNT_POINT /bin/bash -c "find /usr/share/doc -depth -type f ! -name copyright -delete"
          #sudo chroot $MOUNT_POINT /bin/bash -c "find /usr/share/doc -depth -type d -empty -delete"
          #sudo chroot $MOUNT_POINT /bin/bash -c "rm -rf /usr/share/man/* /usr/share/groff/* /usr/share/info/*"
          #sudo chroot $MOUNT_POINT /bin/bash -c "rm -rf /usr/share/lintian/* /usr/share/linda/*"
          #sudo chroot $MOUNT_POINT /bin/bash -c "find /usr/share/locale -mindepth 1 -maxdepth 1 ! -name 'en*' -exec rm -rf {} +"
          
          # Restore original resolv.conf
          sudo chroot $MOUNT_POINT /bin/bash -c "mv /etc/resolv.conf.bak /etc/resolv.conf || true"

          # Clean up
          sudo umount $MOUNT_POINT/dev/pts
          sudo umount $MOUNT_POINT/dev
          sudo umount $MOUNT_POINT/proc
          sudo umount $MOUNT_POINT/sys
          
          sudo umount $MOUNT_POINT/boot/firmware
          sudo umount $MOUNT_POINT
          sudo losetup -d $LOOP_DEVICE
          
          # Compress image with maximum compression settings
          xz --threads=1 --memory=1000MiB --check=crc32 -9e --compress --keep "$IMAGE_PATH"
          mv "${IMAGE_PATH}.xz" /home/runner/work/uConsole-Image-Builder/${{ matrix.device }}-${{ matrix.distro }}-${{ matrix.uconsole_core }}-${{ matrix.desktop }}.img.xz
      
      - name: Process RetroPie image
        if: matrix.desktop == 'retropie'
        run: |
          # Find the RetroPie image built by ClockworkPi-pi-gen
          cd /home/runner/work/uConsole-Image-Builder/uConsole-Image-Builder/retropie-output
          
          # Find the image file (may be compressed or not)
          if ls *.img.xz >/dev/null 2>&1; then
            echo "Found compressed image, decompressing for customization"
            IMAGE_FILE=$(ls *.img.xz | head -1)
            unxz "$IMAGE_FILE"
            IMAGE_PATH="${IMAGE_FILE%.xz}"
          elif ls *.img >/dev/null 2>&1; then
            IMAGE_PATH=$(ls *.img | head -1)
          else
            echo "ERROR: No RetroPie image found!"
            ls -la
            exit 1
          fi
          
          # Now mount and customize the RetroPie image just like standard desktops
          LOOP_DEVICE=$(sudo losetup -f)
          MOUNT_POINT=./rootfs
          
          echo "=====> IMAGE PATH: $IMAGE_PATH"
          echo "=====> LOOP DEVICE: $LOOP_DEVICE"
          echo "=====> MOUNT POINT: $MOUNT_POINT"
          
          # Create loop device and mount partitions
          sudo losetup -D  # Clear existing loop devices
          sudo losetup $LOOP_DEVICE -P "$IMAGE_PATH"
          
          sudo mkdir -p $MOUNT_POINT
          sudo mount ${LOOP_DEVICE}p2 $MOUNT_POINT
          sudo mount ${LOOP_DEVICE}p1 $MOUNT_POINT/boot/firmware
          sudo mount --bind /dev $MOUNT_POINT/dev
          sudo mount --bind /dev/pts $MOUNT_POINT/dev/pts
          sudo mount --bind /proc $MOUNT_POINT/proc
          sudo mount --bind /sys $MOUNT_POINT/sys
          
          sleep 5  # Wait for mounts to stabilize
          
          # Configure DNS resolvers
          sudo chroot $MOUNT_POINT /bin/bash -c "mv /etc/resolv.conf /etc/resolv.conf.bak || true"
          sudo chroot $MOUNT_POINT /bin/bash -c "echo 'nameserver 8.8.8.8' | tee /etc/resolv.conf"
          sudo chroot $MOUNT_POINT /bin/bash -c "echo 'nameserver 8.8.4.4' | tee -a /etc/resolv.conf"
          
          # Remove current linux kernels if any
          sudo chroot $MOUNT_POINT /bin/bash -c "apt remove -y linux-image-* linux-headers-* linux-raspi-headers-* || true"
          
          # Add ClockworkPi repository
          sudo chroot $MOUNT_POINT /bin/bash -c "apt-get update && apt-get install -y --no-install-recommends wget gnupg initramfs-tools"
          sudo chroot $MOUNT_POINT /bin/bash -c "wget -q -O- https://raw.githubusercontent.com/clockworkpi/apt/main/debian/KEY.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/clockworkpi.gpg"
          sudo chroot $MOUNT_POINT /bin/bash -c "echo 'deb [arch=arm64] https://raw.githubusercontent.com/clockworkpi/apt/main/bookworm stable main' | sudo tee -a /etc/apt/sources.list.d/clockworkpi.list"
          sudo chroot $MOUNT_POINT /bin/bash -c "sudo apt update"
          sudo chroot $MOUNT_POINT /bin/bash -c "sudo apt install -y --no-install-recommends clockworkpi-*"
          
          # Install kernel based on CM variant and kernel mode
          # CM3 and CM5 always use built kernels, CM4 can use prebuilt
          if [ "${{ matrix.uconsole_core }}" == "cm4" ] && [ "${{ env.KERNEL_MODE }}" == "prebuilt" ]; then
            sudo chroot $MOUNT_POINT /bin/bash -c "apt install -y --no-install-recommends uconsole-kernel-${{ matrix.uconsole_core }}-rpi"
          else
            sudo cp /home/runner/work/uConsole-Image-Builder/uConsole-Image-Builder/kernel-debs/*.deb $MOUNT_POINT/tmp/
            sudo chroot $MOUNT_POINT /bin/bash -c "dpkg -i /tmp/*.deb || apt install -f -y --no-install-recommends"
          fi
          
          # Configure device-specific config.txt with dtoverlay
          sudo tee $MOUNT_POINT/boot/firmware/config.txt << 'EOF'
          # For more options and information see
          # http://rptl.io/configtxt
          # Some settings may impact device functionality. See link above for details
          
          # Uncomment some or all of these to enable the optional hardware interfaces
          #dtparam=i2c_arm=on
          #dtparam=i2s=on
          #dtparam=spi=on
          
          # Enable audio (loads snd_bcm2835)
          dtparam=audio=on
          
          # Additional overlays and parameters are documented
          # /boot/firmware/overlays/README
          
          # Automatically load overlays for detected cameras
          camera_auto_detect=1
          
          # Automatically load overlays for detected DSI displays
          display_auto_detect=1
          
          # Automatically load initramfs files, if found
          auto_initramfs=1
          
          # Enable DRM VC4 V3D driver
          disable_fw_kms_setup=1
          EOF
          
          # Add device-specific dtoverlay based on matrix.device and matrix.uconsole_core
          if [ "${{ matrix.device }}" == "devterm" ]; then
            if [ "${{ matrix.uconsole_core }}" == "cm3" ]; then
              echo "dtoverlay=clockworkpi-devterm-cm3" | sudo tee -a $MOUNT_POINT/boot/firmware/config.txt
              echo "dtoverlay=vc4-kms-v3d-pi4" | sudo tee -a $MOUNT_POINT/boot/firmware/config.txt
            elif [ "${{ matrix.uconsole_core }}" == "cm4" ]; then
              echo "dtoverlay=clockworkpi-devterm" | sudo tee -a $MOUNT_POINT/boot/firmware/config.txt
              echo "dtoverlay=vc4-kms-v3d-pi4" | sudo tee -a $MOUNT_POINT/boot/firmware/config.txt
            elif [ "${{ matrix.uconsole_core }}" == "cm5" ]; then
              echo "dtoverlay=clockworkpi-devterm-cm5" | sudo tee -a $MOUNT_POINT/boot/firmware/config.txt
              echo "dtoverlay=vc4-kms-v3d-pi5" | sudo tee -a $MOUNT_POINT/boot/firmware/config.txt
            fi
          else
            if [ "${{ matrix.uconsole_core }}" == "cm3" ]; then
              echo "dtoverlay=clockworkpi-uconsole-cm3" | sudo tee -a $MOUNT_POINT/boot/firmware/config.txt
              echo "dtoverlay=vc4-kms-v3d-pi4" | sudo tee -a $MOUNT_POINT/boot/firmware/config.txt
            elif [ "${{ matrix.uconsole_core }}" == "cm4" ]; then
              echo "dtoverlay=clockworkpi-uconsole" | sudo tee -a $MOUNT_POINT/boot/firmware/config.txt
              echo "dtoverlay=vc4-kms-v3d-pi4" | sudo tee -a $MOUNT_POINT/boot/firmware/config.txt
            elif [ "${{ matrix.uconsole_core }}" == "cm5" ]; then
              echo "dtoverlay=clockworkpi-uconsole-cm5" | sudo tee -a $MOUNT_POINT/boot/firmware/config.txt
              echo "dtoverlay=vc4-kms-v3d-pi5" | sudo tee -a $MOUNT_POINT/boot/firmware/config.txt
            fi
          fi
          
          # Set hostname
          sudo chroot $MOUNT_POINT /bin/bash -c "echo 'uconsole' > /etc/hostname"
          sudo chroot $MOUNT_POINT /bin/bash -c "sed -i 's/ubuntu|debian|raspbian|raspberrypi/uconsole/g' /etc/hosts"
          
          # Cleanup to reduce image size
          sudo chroot $MOUNT_POINT /bin/bash -c "apt-get autoremove -y"
          sudo chroot $MOUNT_POINT /bin/bash -c "apt-get clean"
          sudo chroot $MOUNT_POINT /bin/bash -c "rm -rf /var/lib/apt/lists/*"
          sudo chroot $MOUNT_POINT /bin/bash -c "rm -rf /tmp/*"
          sudo chroot $MOUNT_POINT /bin/bash -c "rm -rf /var/tmp/*"
          sudo chroot $MOUNT_POINT /bin/bash -c "rm -rf /var/cache/apt/archives/*.deb"
          sudo chroot $MOUNT_POINT /bin/bash -c "rm -rf /var/log/*.log /var/log/*.old /var/log/*.gz"
          
          # Restore original resolv.conf
          sudo chroot $MOUNT_POINT /bin/bash -c "mv /etc/resolv.conf.bak /etc/resolv.conf || true"
          
          # Clean up mounts
          sudo umount $MOUNT_POINT/dev/pts
          sudo umount $MOUNT_POINT/dev
          sudo umount $MOUNT_POINT/proc
          sudo umount $MOUNT_POINT/sys
          sudo umount $MOUNT_POINT/boot/firmware
          sudo umount $MOUNT_POINT
          sudo losetup -d $LOOP_DEVICE
          
          # Compress the customized image
          echo "Compressing customized RetroPie image"
          xz --threads=1 --memory=1000MiB --check=crc32 -9e --compress "$IMAGE_PATH"
          mv "${IMAGE_PATH}.xz" /home/runner/work/uConsole-Image-Builder/${{ matrix.device }}-${{ matrix.distro }}-${{ matrix.uconsole_core }}-${{ matrix.desktop }}.img.xz

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.device }}-${{ matrix.distro }}-${{ matrix.uconsole_core }}-${{ matrix.desktop }}.img.xz
          path: /home/runner/work/uConsole-Image-Builder/${{ matrix.device }}-${{ matrix.distro }}-${{ matrix.uconsole_core }}-${{ matrix.desktop }}.img.xz

  release:
    needs: [prepare-kernel, build-image]
    runs-on: ubuntu-24.04-arm
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    strategy:
      matrix:
        distro: [bookworm, trixie, jammy]
        uconsole_core: [cm3, cm4, cm5]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download kernel artifacts (${{ matrix.uconsole_core }})
        if: needs.prepare-kernel.outputs.kernel_mode == 'build'
        uses: actions/download-artifact@v4
        with:
          name: kernel-debs-${{ matrix.uconsole_core }}
          path: /home/runner/work/uConsole-Image-Builder/release/

      - name: Download patch artifacts (${{ matrix.uconsole_core }})
        if: needs.prepare-kernel.outputs.kernel_mode == 'build'
        uses: actions/download-artifact@v4
        with:
          name: kernel-patch-uconsole-${{ matrix.uconsole_core }}
          path: /home/runner/work/uConsole-Image-Builder/release/

      # Download only images for this specific distro-core combination (both devices)
      # Pattern matches artifacts from build-image job:
      # {device}-{distro}-{core}-{desktop}.img.xz
      - name: Download image artifacts for ${{ matrix.distro }}-${{ matrix.uconsole_core }}
        uses: actions/download-artifact@v4
        with:
          pattern: "*-${{ matrix.distro }}-${{ matrix.uconsole_core }}-*.img.xz"
          path: /home/runner/work/uConsole-Image-Builder/release/
          merge-multiple: true          

      - name: Create release tag
        id: tag
        run: |
          TAG_NAME="release-$(date +'%Y%m%d-%H%M%S')"
          FULL_TAG_NAME="uconsole-${{ env.KERNEL_VERSION }}-${TAG_NAME}-${{ matrix.distro }}-${{ matrix.uconsole_core }}"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "full_tag_name=$FULL_TAG_NAME" >> $GITHUB_OUTPUT
          git tag "$FULL_TAG_NAME"
          git push origin "$FULL_TAG_NAME"
          ls -laR /home/runner/work/uConsole-Image-Builder/release/

      - name: Create GitHub Release for ${{ matrix.distro }}-${{ matrix.uconsole_core }}
        if: needs.prepare-kernel.outputs.kernel_mode == 'build'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.full_tag_name }}
          name: uConsole Images - ${{ matrix.distro }} - ${{ matrix.uconsole_core }} - ${{ env.KERNEL_VERSION }}
          files: |
            /home/runner/work/uConsole-Image-Builder/release/*.img.xz
            /home/runner/work/uConsole-Image-Builder/release/*.deb
            /home/runner/work/uConsole-Image-Builder/release/*.diff
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release for ${{ matrix.distro }}-${{ matrix.uconsole_core }}
        if: needs.prepare-kernel.outputs.kernel_mode == 'prebuilt'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.full_tag_name }}
          name: uConsole Images - ${{ matrix.distro }} - ${{ matrix.uconsole_core }} - ${{ env.KERNEL_VERSION }}
          files: |
            /home/runner/work/uConsole-Image-Builder/release/*.img.xz            
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}          

